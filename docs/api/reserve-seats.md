# üéØ API de Reserva de Asientos - Documentaci√≥n Completa

## üìã Descripci√≥n General

Esta API permite al usuario autenticado reservar m√∫ltiples asientos en un horario de clase espec√≠fico. Los asientos se reservan temporalmente y expiran despu√©s del tiempo especificado.

---

## üîó Endpoint

```http
POST /api/class-schedules/{classSchedule}/reserve-seats
```

### üîê Autenticaci√≥n Requerida
```http
Authorization: Bearer {tu_token_aqui}
```

---

## üìù Par√°metros

### **URL Parameters**
| Par√°metro | Tipo | Descripci√≥n | Ejemplo |
|-----------|------|-------------|---------|
| `classSchedule` | integer | ID del horario de clase | `5` |

### **Body Parameters (JSON)**
| Par√°metro | Tipo | Requerido | Descripci√≥n | Ejemplo |
|-----------|------|-----------|-------------|---------|
| `seat_ids` | array | ‚úÖ S√≠ | Array de IDs de asientos a reservar (m√°x 10) | `[1, 2, 3]` |
| `minutes_to_expire` | integer | ‚ùå No | Minutos antes de que expire la reserva (5-60, default: 15) | `15` |

---

## üì§ Ejemplos de Solicitudes

### **1. Reservar un Solo Asiento**
```bash
curl -X POST "http://backend-resistanc.test/api/class-schedules/5/reserve-seats" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer tu_token_aqui" \
  -d '{
    "seat_ids": [1]
  }'
```

### **2. Reservar M√∫ltiples Asientos**
```bash
curl -X POST "http://backend-resistanc.test/api/class-schedules/5/reserve-seats" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer tu_token_aqui" \
  -d '{
    "seat_ids": [1, 2, 3],
    "minutes_to_expire": 20
  }'
```

### **3. Reservar con Tiempo Personalizado**
```bash
curl -X POST "http://backend-resistanc.test/api/class-schedules/5/reserve-seats" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer tu_token_aqui" \
  -d '{
    "seat_ids": [4, 5],
    "minutes_to_expire": 30
  }'
```

---

## üì• Respuestas

### ‚úÖ **Respuesta Exitosa (200)**
```json
{
  "success": true,
  "message": "Asientos reservados exitosamente",
  "data": {
    "reserved_seats": [
      {
        "seat_id": 1,
        "assignment_id": 123,
        "seat_number": "1.1",
        "row": 1,
        "column": 1,
        "status": "reserved",
        "reserved_at": "2024-06-15T10:30:00.000Z",
        "expires_at": "2024-06-15T10:45:00.000Z"
      },
      {
        "seat_id": 2,
        "assignment_id": 124,
        "seat_number": "1.2",
        "row": 1,
        "column": 2,
        "status": "reserved",
        "reserved_at": "2024-06-15T10:30:00.000Z",
        "expires_at": "2024-06-15T10:45:00.000Z"
      }
    ],
    "reservation_summary": {
      "total_reserved": 2,
      "expires_in_minutes": 15,
      "expires_at": "2024-06-15T10:45:00.000Z",
      "user_id": 10,
      "schedule_id": 5,
      "class_name": "Hatha Yoga",
      "studio_name": "Sala Yoga A",
      "scheduled_date": "2024-06-15",
      "start_time": "08:00:00"
    }
  }
}
```

### ‚ùå **Asientos No Disponibles (400)**
```json
{
  "success": false,
  "message": "Algunos asientos no est√°n disponibles",
  "data": {
    "unavailable_seats": [
      {
        "seat_id": 1,
        "current_status": "reserved",
        "user_id": 8
      }
    ],
    "available_seats": [2, 3]
  }
}
```

### ‚ùå **Asientos No Asignados al Horario (400)**
```json
{
  "success": false,
  "message": "Algunos asientos no est√°n asignados a este horario",
  "data": {
    "missing_seat_ids": [99, 100],
    "available_seat_ids": [1, 2, 3, 4, 5]
  }
}
```

### ‚ùå **Horario No Encontrado (404)**
```json
{
  "success": false,
  "message": "Horario de clase no encontrado",
  "data": null
}
```

### ‚ùå **Reservas Cerradas (422)**
```json
{
  "success": false,
  "message": "Las reservas se cierran 2 horas antes del inicio de la clase",
  "data": {
    "reason": "booking_closed"
  }
}
```

### ‚ùå **Horario Cancelado (422)**
```json
{
  "success": false,
  "message": "No se puede reservar en un horario cancelado",
  "data": {
    "reason": "schedule_cancelled"
  }
}
```

### ‚ùå **Horario Pasado (422)**
```json
{
  "success": false,
  "message": "No se puede reservar en un horario pasado",
  "data": {
    "reason": "schedule_past"
  }
}
```

### ‚ùå **Validaci√≥n de Datos (422)**
```json
{
  "message": "The given data was invalid.",
  "errors": {
    "seat_ids": ["Debe especificar al menos un asiento para reservar"],
    "minutes_to_expire": ["Los minutos de expiraci√≥n deben ser un n√∫mero entero"]
  }
}
```

### ‚ùå **No Autenticado (401)**
```json
{
  "message": "Unauthenticated."
}
```

### ‚ùå **Error Interno (500)**
```json
{
  "success": false,
  "message": "Error interno al reservar asientos",
  "data": null
}
```

---

## üíª Ejemplos de C√≥digo

### **JavaScript (Fetch)**
```javascript
async function reserveSeats(scheduleId, seatIds, minutesToExpire = 15, token) {
  try {
    const response = await fetch(`http://backend-resistanc.test/api/class-schedules/${scheduleId}/reserve-seats`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`,
        'Accept': 'application/json'
      },
      body: JSON.stringify({
        seat_ids: seatIds,
        minutes_to_expire: minutesToExpire
      })
    });

    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.message || `HTTP error! status: ${response.status}`);
    }

    console.log('‚úÖ Asientos reservados:', data.data.reserved_seats.length);
    console.log('‚è∞ Expiran en:', data.data.reservation_summary.expires_in_minutes, 'minutos');
    
    return data;
  } catch (error) {
    console.error('‚ùå Error al reservar asientos:', error.message);
    throw error;
  }
}

// Ejemplos de uso
const token = 'tu_token_aqui';

// Reservar un asiento
reserveSeats(5, [1], 15, token);

// Reservar m√∫ltiples asientos
reserveSeats(5, [1, 2, 3], 20, token);

// Reservar con tiempo personalizado
reserveSeats(5, [4, 5], 30, token);
```

### **JavaScript (Axios)**
```javascript
import axios from 'axios';

const api = axios.create({
  baseURL: 'http://backend-resistanc.test/api',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${localStorage.getItem('token')}`
  }
});

async function reserveSeats(scheduleId, seatIds, minutesToExpire = 15) {
  try {
    const response = await api.post(`/class-schedules/${scheduleId}/reserve-seats`, {
      seat_ids: seatIds,
      minutes_to_expire: minutesToExpire
    });

    return response.data;
  } catch (error) {
    if (error.response?.status === 400) {
      console.error('Asientos no disponibles:', error.response.data.data.unavailable_seats);
    } else if (error.response?.status === 422) {
      console.error('No se puede reservar:', error.response.data.data.reason);
    }
    throw error;
  }
}

// Uso con manejo de errores
reserveSeats(5, [1, 2, 3])
  .then(data => {
    console.log('Reserva exitosa:', data.data.reservation_summary);
  })
  .catch(error => {
    console.error('Error en reserva:', error.response?.data?.message);
  });
```

### **PHP (Guzzle)**
```php
<?php
use GuzzleHttp\Client;
use GuzzleHttp\Exception\RequestException;

class SeatReservationService {
    private $client;
    private $token;

    public function __construct(string $token) {
        $this->token = $token;
        $this->client = new Client([
            'base_uri' => 'http://backend-resistanc.test/api/',
            'headers' => [
                'Content-Type' => 'application/json',
                'Authorization' => "Bearer {$token}",
                'Accept' => 'application/json'
            ]
        ]);
    }

    public function reserveSeats(int $scheduleId, array $seatIds, int $minutesToExpire = 15): array {
        try {
            $response = $this->client->post("class-schedules/{$scheduleId}/reserve-seats", [
                'json' => [
                    'seat_ids' => $seatIds,
                    'minutes_to_expire' => $minutesToExpire
                ]
            ]);

            return json_decode($response->getBody(), true);
        } catch (RequestException $e) {
            $response = $e->getResponse();
            if ($response) {
                $errorData = json_decode($response->getBody(), true);
                
                if ($response->getStatusCode() === 400) {
                    throw new Exception('Asientos no disponibles: ' . $errorData['message']);
                } elseif ($response->getStatusCode() === 422) {
                    throw new Exception('No se puede reservar: ' . $errorData['data']['reason']);
                }
            }
            
            throw new Exception('Error al reservar asientos: ' . $e->getMessage());
        }
    }
}

// Uso
$service = new SeatReservationService('tu_token_aqui');

try {
    $result = $service->reserveSeats(5, [1, 2, 3], 20);
    echo "Asientos reservados: " . $result['data']['reservation_summary']['total_reserved'] . "\n";
    echo "Expiran en: " . $result['data']['reservation_summary']['expires_in_minutes'] . " minutos\n";
} catch (Exception $e) {
    echo "Error: " . $e->getMessage() . "\n";
}
```

### **Python (Requests)**
```python
import requests
from typing import List, Dict, Any

class SeatReservationAPI:
    def __init__(self, base_url: str, token: str):
        self.base_url = base_url
        self.headers = {
            'Content-Type': 'application/json',
            'Authorization': f'Bearer {token}',
            'Accept': 'application/json'
        }

    def reserve_seats(self, schedule_id: int, seat_ids: List[int], minutes_to_expire: int = 15) -> Dict[str, Any]:
        """Reservar asientos en un horario espec√≠fico"""
        url = f'{self.base_url}/api/class-schedules/{schedule_id}/reserve-seats'
        
        payload = {
            'seat_ids': seat_ids,
            'minutes_to_expire': minutes_to_expire
        }

        try:
            response = requests.post(url, json=payload, headers=self.headers)
            response.raise_for_status()
            return response.json()
        except requests.exceptions.HTTPError as e:
            if response.status_code == 400:
                error_data = response.json()
                raise ValueError(f"Asientos no disponibles: {error_data['message']}")
            elif response.status_code == 422:
                error_data = response.json()
                raise ValueError(f"No se puede reservar: {error_data['data']['reason']}")
            raise e

# Uso
api = SeatReservationAPI('http://backend-resistanc.test', 'tu_token_aqui')

try:
    result = api.reserve_seats(5, [1, 2, 3], 20)
    summary = result['data']['reservation_summary']
    print(f"‚úÖ {summary['total_reserved']} asientos reservados")
    print(f"‚è∞ Expiran en {summary['expires_in_minutes']} minutos")
    print(f"üìÖ Clase: {summary['class_name']} en {summary['studio_name']}")
except ValueError as e:
    print(f"‚ùå Error: {e}")
```

---

## üîç Validaciones y Restricciones

### **Validaciones de Entrada:**
- ‚úÖ `seat_ids` debe ser un array con al menos 1 elemento
- ‚úÖ M√°ximo 10 asientos por reserva
- ‚úÖ Cada `seat_id` debe existir en la base de datos
- ‚úÖ `minutes_to_expire` debe estar entre 5 y 60 minutos

### **Restricciones de Negocio:**
- ‚úÖ Solo usuarios autenticados pueden reservar
- ‚úÖ No se puede reservar en horarios cancelados
- ‚úÖ No se puede reservar en horarios pasados
- ‚úÖ Las reservas se cierran 2 horas antes del inicio
- ‚úÖ Solo se pueden reservar asientos disponibles
- ‚úÖ Los asientos deben estar asignados al horario espec√≠fico

### **Caracter√≠sticas de Seguridad:**
- ‚úÖ Transacciones de base de datos para consistencia
- ‚úÖ Bloqueo de registros para evitar condiciones de carrera
- ‚úÖ Validaci√≥n de permisos por usuario autenticado
- ‚úÖ Logging de errores para debugging

---

## üéØ Casos de Uso

### **1. Reserva Individual**
```javascript
// Reservar un asiento espec√≠fico
reserveSeats(5, [1], 15, token);
```

### **2. Reserva Grupal**
```javascript
// Reservar asientos para un grupo
reserveSeats(5, [1, 2, 3, 4], 30, token);
```

### **3. Reserva con Tiempo Extendido**
```javascript
// Reservar con m√°s tiempo para decidir
reserveSeats(5, [5, 6], 45, token);
```

### **4. Manejo de Errores**
```javascript
try {
  await reserveSeats(5, [1, 2], 15, token);
} catch (error) {
  if (error.message.includes('no est√°n disponibles')) {
    // Mostrar asientos alternativos
  } else if (error.message.includes('reservas se cierran')) {
    // Informar que ya no se puede reservar
  }
}
```

---

## üìã Checklist de Pruebas

- [ ] ‚úÖ Reserva exitosa de un asiento
- [ ] ‚úÖ Reserva exitosa de m√∫ltiples asientos
- [ ] ‚ùå Error con asientos no disponibles
- [ ] ‚ùå Error con asientos inexistentes
- [ ] ‚ùå Error con horario no encontrado
- [ ] ‚ùå Error con horario cancelado
- [ ] ‚ùå Error con horario pasado
- [ ] ‚ùå Error con reservas cerradas
- [ ] üîê Error sin autenticaci√≥n
- [ ] üìä Validaci√≥n de datos de entrada
- [ ] ‚è∞ Verificaci√≥n de tiempo de expiraci√≥n

---

## üéâ **¬°Endpoint Listo para Usar!**

Ahora puedes reservar m√∫ltiples asientos para el usuario autenticado usando:

```
POST /api/class-schedules/{classSchedule}/reserve-seats
```

Con el cuerpo JSON:
```json
{
  "seat_ids": [1, 2, 3],
  "minutes_to_expire": 15
}
```
